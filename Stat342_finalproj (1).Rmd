---
title: "Title"
subtitle: "Alexandra Orczyk, Vy Nguyen, Xiyue Huang"
graphics: yes
output: 
        pdf_document:
         toc: false
         number_sections: true
urlcolor: blue
header-includes:
- \usepackage{amsmath,amsfonts,amssymb}
- \usepackage{multicol,graphicx,hyperref,xcolor}
- \usepackage{setspace} \doublespacing
fontsize: 11pt

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
```

# Abstract: 

During the COVID-19 pandemic, Tens of millions of people have been infected with COVID-19, emphasizing the importance of safe and effective vaccines. In December 2020, Pfizer and BioNTech were granted permission to distribute their BNT162b2 vaccine, a nucleoside-modified RNA vaccine encoding the SARS-CoV-2 spike protein. To test its efficacy, a placebo-controlled, observer-blinded trial was conducted with 35,092 participants aged 16 and older, randomized in a 1:1 ratio to receive two doses of BNT162b2 or placebo, 21 days apart. The study targeted 170 infections resulting in 8 cases in the vaccine group and 162 in the placebo group, indicating a vaccine efficacy of 95%. A Bayesian beta-binomial model confirmed this efficacy, with a 95% confidence interval of [90.3%, 97.6%] and a probability greater than 0.9999 that the efficacy exceeds 30%, indicating the vaccine's outstanding efficacy. In this project, we will conduct a similar analysis and approach the result by using different methods to measure the safety and efficacy of the vaccine. 

# Keywords:

COVID-19, BNT162b2, Vaccine efficacy, Binomial distribution, Hypothesis testing, Confidence Interval

# Introduction:

Prior studies on the efficacy of the various COVID-19 vaccines, particiularly the Pfizer and Moderna mRNA vaccines, have found them to be highly effective at lowering infection, lowering the severity of symptoms, and preventing hospitalization and death. For example, Cai, Peng, et.al calculated a 95% confidence interval of $93.65$%â€“$95.40$% as an estimate of the vaccine efficacy rate of the mRNA vaccines, which was defined as $\frac{\text{Risk among unvaccinated group} - \text{risk among vaccinated group}}{\text{Risk among unvaccinated group}}$. Similarly, a systematic review by Grana, Ghosn, et. al found "high-certainty evidence" that the BioNTech/Pfizer vaccine reduced both the prevalence of symptomatic COVID-19 and symptom severity compared to placebo. However, they found lower efficacy against newer COVID-19 variants. Although there are some estimates that make the vaccines seem less effective, such as the Absolute Risk Reduction of 0.9% for the Pfizer vaccine reported by Olliaro, Torreele, et.al, however, since this statistic reports the difference in infection rates between the unvaccinated and vaccinated population, it has the flaw of reporting a higher degree of efficacy for the vaccines tested in populations with a higher rate of Covid-19, which is why most studies use other estimators. Overall, the majority of studies report a high degree of efficacy for the mRNA Covid-19 vaccines.

# Statistical Methods:

#Model: Single Binomial random variables

Let X denote the # in the BNT162b2 group out of all the n=170 Covid-19 cases

Then, $X \sim Binom(n=170, \pi)$

The likelihood function for $\pi$ is 

$$L(\pi) = \binom{n}{x}\pi^x.(1-\pi)^{n-x}$$

Since we are interested in the vaccine efficacy of the BNT162b2, our parameter of $\psi$ in terms of the binomial probability $\pi$ as follow:

$$\psi = \frac{1-2\pi}{1-\pi}$$
We can write $\pi = g(\psi) = \frac{1-\psi}{2-\psi}$ 

__Method 1:  Likelihood Inference for Vaccine efficacy__

In order to estimate the vaccine efficacy, we can construct a likelihood function for $\psi$ and then use it to derive confidence intervals and perform hypothesis testing

$L(\psi) = L(g(\psi)) = \binom{n}{x}(\frac{1-\psi}{2-\psi})^x.(1-\frac{1-\psi}{2-\psi})^{n-x}$

\begin{align*}
L(\psi) &= \binom{n}{x}(\frac{1-\psi}{2-\psi})^x.(1-\frac{1-\psi}{2-\psi})^{n-x} \\
&= \binom{n}{x}(\frac{1-\psi}{2-\psi})^x.(\frac{2- \psi - 1 + \psi}{2-\psi})^{n-x} \\
&= \binom{n}{x}(1-\psi)^x(\frac{1}{2-\psi})^x.(\frac{1}{2-\psi})^{n-x} \\
&= \binom{n}{x}\frac{(1-\psi)^x}{(2-\psi)^n} \ \ \ \ \ \  -\infty \leq \psi \leq 1
\end{align*}

To find $\psi^{mle}$, we will derive the first derivative of the log-likelihood function

\begin{align*}
\frac{d}{d_\psi}ln(L(\psi)) &=  \frac{d}{d_\psi}(ln\binom{n}{x} +ln(1-\psi)^x - ln(2-\psi)^n) \ \ \ \ \ \  0\leq \psi < \infty \\
&= \frac{-x}{1-\psi} + \frac{n}{2-\psi}
\end{align*}

Candidates for the MLE of $\psi$ satisfy the equation:

\begin{align*}
\frac{d}{d_\psi}ln(L(\psi_0)) &=0 \\
\frac{-x}{1-\psi_0} + \frac{n}{2-\psi_0} &= 0 \\
\frac{n}{2-\psi_0} &= \frac{x}{1-\psi_0} \\
n(1-\psi_0) &= x(2-\psi_0) \\
n -n\psi_0 &= 2x - x\psi_0 \\
n-2x &= (n-x)\psi_0 \\
\psi_0^{mle} &= \frac{n-2x}{n-x}
\end{align*}

Second derivative:

\begin{align*}
\frac{d}{d_\psi}ln'(L(\psi_0)) &=  \frac{d}{d_\psi}(\frac{-x}{1-\psi_0} + \frac{n}{2-\psi_0})\\
&= \frac{x}{(1-\psi_0)^2} - \frac{n}{(2-\psi_0)^2}
\end{align*} 

Confident Interval of $\psi_0^{mle}$

By theorem 25.1, we get $\psi_0^{mle}$ is approximately normally distributed with mean $\psi_0$ and estimated standard error given by $\sqrt{\frac{1}{l"(\psi_0^{mle})}}$

We have: 

\begin{align*}
l"(\psi_0^{mle}) &= \frac{d}{d_{\psi_0}}(\frac{-x}{1-\psi} + \frac{n}{2-\psi})\\
&= -\frac{x}{(1-\psi_0)^2} + \frac{n}{(2-\psi_0)^2} \\
&= \frac{-x}{(1-\frac{n-2x}{n-x})^2} + \frac{n}{(2-\frac{n-2x}{n-x})^2} \\
&= \frac{-x}{(\frac{n-x -n+2x}{n-x})^2} + \frac{n}{(\frac{2n-2x-n+2x}{n-x})^2} \\
&= \frac{-x}{(\frac{x}{n-x})^2} + \frac{n}{(\frac{n}{n-x})^2} \\
&= \frac{-1}{\frac{x}{(n-x)^2}} + \frac{1}{\frac{n}{(n-x)^2}} \\
&= (n-x)^2(\frac{1}{n}-\frac{1}{x})
\end{align*}

Now let check the second derivative to see if $\psi_0^{mle}$ is maximum likelihood estimate of $\psi_0$ 

Since $(n-x)^2 \geq 0$, let's check if $\frac{1}{n}-\frac{1}{x}$

As we know that $x \leq n$, then $\frac{1}{n} \leq \frac{1}{x} = \frac{1}{n} - \frac{1}{x} \leq 0$

Thus, $l"(\psi_0^{mle}) = (n-x)^2(\frac{1}{n}-\frac{1}{x})  \leq  0$, so $\psi_0^{mle}$ is maximum likelihood estimate of $\psi_0$.


Now we can derive the standard error of $\psi_0$

\begin{align*}
SE(\psi_0) &= \sqrt{\frac{-1}{l"(\psi^{mle})}} \\
&= \sqrt{\frac{(1-\psi_0)^2(2-\psi_0)^2}{x(2-\psi_0)^2-n(1-\psi_0)^2}} \\
&= \frac{(1-\psi_0)(2-\psi_0)}{\sqrt{x(2-\psi_0)^2-n(1-\psi_0)^2}}
\end{align*}

Hence, the Confidence Interval for $\psi_0$ is:

$\hat{\psi_0}^{mle} \pm z_{\alpha/2}.SE = \hat{\psi_0}^{mle} \pm z_{\alpha/2}.\frac{(1-\psi_0)(2-\psi_0)}{\sqrt{-x(2-\psi_0)^2+n(1-\psi_0)^2}}$

Let $\psi_0$ denote the true (but unknown) value of vaccine efficacy. We want to test:

$H_0: \psi_0 = \psi_0^{null}$,

$H_1: \psi_0 \not= \psi_0^{null}$

The likelihood ratio test statistic is:

$$W = 2ln[\frac{L(\hat{\psi_0}^{mle})}{L(\psi_0^{null})}] = 2ln[l(\psi_0^{mle}) -l(\psi_0^{null})] \approx X_1^2$$
We can calculate P value as following: 

p-value = $P(X_1^2 \geq w) = pchisq(w, df=1, lower.tail = F)$ 



__Method 2:  Method of Moment Inference for Vaccine efficacy__

We are interested in the value of $\hat\psi^{mom}_0$. Since $\pi = \frac{1-\psi}{2-\psi}$, we can find the M.O.M estimate of $\psi_0$ by solving the equation $E(X) = \bar{x}$, where $\bar{x}$ equals to x in our data.

\begin{align*}
E(X) &= x \\
n\pi &= x \\
n \frac{1-\psi}{2-\psi} &= x \\
2x - x \psi &= n - n \psi \\
\psi (n-x) &= n-2x \\
\psi &= \frac{n-2x}{n-x}
\end{align*}

Therefore, $\hat\psi^{mom}_0 = \frac{n-2x}{n-x}$.
Now, in order to make inferences about $\psi$ (the vaccine efficacy) using the method of moments (MOM) approach, we can construct confidence intervals (CI) and conduct hypothesis testing. 

To construct confidence intervals for $\psi$, we will use bootstrapping method.
In the context of vaccine efficacy, we will first randomly re-sample the original data with replacement. Second, for each re-sample, calculate the desired statistic (e.g.,$\psi$, the vaccine efficacy). Then, repeat the re-sampling process many times (e.g., 100 times) to build a distribution of the statistic. Finally, using the bootstrap distribution to calculate confidence intervals of $\psi$:

$$\hat\psi^{mom}_0 \pm Z_{\alpha/2}SE(\hat\psi^{mom}_0)$$

where $\alpha$ is the significant level.

Another statistical inference of our estimation is hypothesis testing. In the context of vaccine efficacy, let $\psi_0$ denote the true (but unknown) value of vaccine efficacy. We want to test:

$H_0: \psi_0 = \psi_0^{null}$,

$H_1: \psi_0 \not= \psi_0^{null}$

By using the empirical p-value from the bootstrap distribution, we can make a more robust inference about the vaccine efficacy $\psi$. If the empirical p-value is less than the significance level, we reject the null hypothesis and conclude that the vaccine has a significant effect.

# Result

```{r}
data = data.frame(
  group = c("BioNTech-Pfizer", "Placebo"),
  num_cases = c(8, 162),
  count = c("17,411 subjects", "17,511 subjects")
)

ggplot(data, aes(x = group, y = num_cases)) + 
    geom_col(fill = "#0099f9", width = 0.6) +  labs(
      title = "Number of Covid-19 Cases in Group Receiving Pfizer Vaccine vs. Placebo", y= "Number of cases at least 7 days after receiving dose"
  ) + geom_text(aes(label = count), vjust=-0.5)
```


__Method 1:  Likelihood Inference for Vaccine efficacy__

We know there is a total of 170 infections including 8 cases of BNT162b2 vaccine, so n = 170 and x = 8

Let's calculate $\psi_0^{mle}$

```{r}
mle <- (170 - 2*8)/(170-8)
mle
```

$\psi_0^{mle} = \frac{n-2x}{n-x} = \frac{170 - 2*8}{170-8} =$ `r mle`.

We can estimate the standard error:

$SE = \frac{(1-\psi_0)(2-\psi_0)}{\sqrt{x(2-\psi_0)^2-n(1-\psi_0)^2}}$

```{r}
se <- (1-mle)*(2-mle)/sqrt(8*(2-mle)^2 - 170*(1-mle)^2)
se
```


Let $\psi_0$ denote the true (but unknown) value of vaccine efficacy. We want to test:

$H_0: \psi_0 = \psi_0^{null} = 0.3$,

$H_1: \psi_0 \not= \psi_0^{null}$

The likelihood ratio test statistic is:

$$W = 2ln[\frac{L(\hat{\psi_0}^{mle})}{L(\psi_0^{null})}] = 2[l(\psi_0^{mle}) -l(\psi_0^{null})]$$
First we need to calculate $L(\psi_0^{mle})$ 

```{r}
n = 170
x = 8
```


```{r}
L_mle <- choose(n ,x)*(1-mle)^x * (1/(2-mle))^n
```

$L(\psi_0^{null})$ 

```{r}
null = 0.3
L_null <- choose(n ,x)*(1-null)^x * (1/(2-null))^n
```


```{r}
w = 2*log(L_mle/L_null)
w
```

```{r}
pvalue = pchisq(w, df=1, lower.tail = F)
pvalue
```

if our sample size is not very large, we can calculate empirical P-value by simulation.

```{r}
obs_w = 121

set.seed(123)
B <- 100


psi_null = 0.3
n = 170
x = 8
### probability of COVID with vaccine
cases_vaccine = (1-psi_null)/(2-psi_null)
### probability of COVID with no vaccine 
cases_placebo = 1-cases_vaccine

null_wstar = numeric(B)

for(i in 1:B) {
  sample_boot <- sample(c(1, 0), size = n, replace = TRUE, prob = c(cases_vaccine, cases_placebo))
  xstar <- sum(sample_boot == 1)
  mle <- (n - 2 * xstar) / (n - xstar)
  loglik_mle <- log(choose(n, xstar)) + xstar*log(1 - mle) - n*log(2 - mle)
  loglik_null <- log(choose(n, xstar)) + xstar*log(1 - psi_null) - n*log(2 - psi_null)
  null_wstar[i] <- 2 * (loglik_mle - loglik_null)
}

# Visualize the null distribution of wstar
ggplot(data = data.frame(x = null_wstar),
       mapping = aes(x = x)) +
  geom_histogram(mapping = aes(y = after_stat(density)),
                 binwidth = 0.7) +
  geom_vline(xintercept = obs_w, color = "red") +
  labs(title = "Null distribution of W")

pvalue <- mean(null_wstar >= obs_w)
cat("Empirical P-value:", pvalue)
```

Plot for log likelihood function

```{r}
# Define the log-likelihood function
loglik.binom <- function(phi, x, n) {
  ifelse((phi < 0 | phi > 1), NA, log(choose(n, x)) + x * log(1 - phi) - n * (2 - phi))
}

# Example data
n <- 170
x <- 8

theta_0_mle_estimate <- (n-2*x)/(n-x)

phi_values <- seq(0, 1, by = 0.01)
log_likelihood_values <- sapply(phi_values, function(phi) loglik.binom(phi, x, n))

# plot of log likelihood function for phi
plot(phi_values, log_likelihood_values, type = "l",
     xlab = "phi", ylab = "log-likelihood", main = "Log-Likelihood Function")
abline(v = theta_0_mle_estimate, col = "blue")
text(x = theta_0_mle_estimate, y = max(-340:-220), labels = "MLE", pos = 2, col = "blue")

```
Regularity Condition Check


```{r,warning=FALSE}
# Define the second-order Taylor approximation function
taylor_approx <- function(phi, x, n, phi_hat) {
  loglik_prime <- - x / (1 - phi_hat) + n / (2 - phi_hat)
  loglik_double_prime <- - x / (1 - phi_hat)^2 + n / (2 - phi_hat)^2
  return(loglik.binom(phi_hat, x, n) + loglik_prime * (phi - phi_hat) + 0.5 * loglik_double_prime * (phi - phi_hat)^2)
}

phi_values <- seq(0.01, 0.99, by = 0.01)

# Compute the log-likelihood values and the second-order Taylor approximation
loglik_values <- loglik.binom(phi_values, 8, 170)
taylor_values <- taylor_approx(phi_values, 8, 170, theta_0_mle_estimate)

# Create a dataframe for plotting
df <- data.frame(phi = phi_values, loglik = loglik_values, taylor = taylor_values)

# Plot
ggplot(df, aes(phi)) +
  geom_line(aes(y = loglik, color = "Log-Likelihood"), size = 1) +
  geom_line(aes(y = taylor, color = "Taylor Approximation"), linetype = "dashed", size = 1) +
  geom_vline(xintercept = theta_0_mle_estimate, color = "blue", linetype = "dotted", size = 1) +
  labs(title = "Log-Likelihood and Second-Order Taylor Approximation",
       x = expression(phi),
       y = "Log-Likelihood") +
  scale_color_manual(values = c("black", "red"),
                     labels = c("Log-Likelihood", "Taylor Approximation")) +
  theme_minimal() +
  annotate("text", x = theta_0_mle_estimate + 0.05, y = max(df$loglik, na.rm = TRUE) - 100, 
           label = "MLE", color = "blue")
```


__Method 2:  Method of Moment Inference for Vaccine efficacy__


MOM

Perform bootstrap sampling.
Calculate the method of moments estimate for each sample.
Calculate the confidence interval for each bootstrap sample.
Plot the confidence intervals.

```{r}
# Define parameters
B <- 100
n <- 170
prob1 <- 8 / 170
prob2 <- 162 / 170
z <- qnorm(0.975)

# Initialize vectors to store bootstrap values and confidence intervals
boot_values <- numeric(B)
se_boot <- numeric(B)
lower_mom_boot <- numeric(B)
upper_mom_boot <- numeric(B)

# Perform bootstrap sampling
set.seed(123)  # For reproducibility
for (i in 1:B) {
  sample_boot <- sample(c(1, 0), size = n, replace = TRUE, prob = c(prob1, prob2))
  x <- length(which(sample_boot == 1))
  boot_values[i] <- (n - 2*x) / (n - x)
  se_boot[i] <- sd(sample_boot)  # Standard error for each bootstrap sample
  lower_mom_boot[i] <- boot_values[i] - z * se_boot[i]
  upper_mom_boot[i] <- boot_values[i] + z * se_boot[i]
}

# Calculate overall standard error for the estimator
se <- sd(boot_values)

# Calculate overall confidence interval for the estimator
psi_mom <- 154 / 162
lower_mom <- psi_mom - z * se
upper_mom <- psi_mom + z * se

# Print results
cat("95% Confidence Interval for psi_mom:", lower_mom, "to", upper_mom, "\n")
```

```{r}
# Create a dataframe for plotting
sample_summary <- data.frame(
  sample = 1:B,
  lower = lower_mom_boot,
  upper = upper_mom_boot,
  estimate = boot_values
)

# Plot the confidence intervals for the bootstrap samples
ggplot(data = sample_summary) +
  geom_segment(mapping = aes(x = lower, xend = upper, y = sample, yend = sample), color = "blue") +
  labs(x = "Sample Confidence Interval", y = "Bootstrap Samples",
       title = "90% Confidence Interval for 100 Bootstrap Samples") +
  theme_minimal() +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  geom_vline(xintercept = psi_mom, color = "red", linetype = "dashed") +
  annotate("text", x = psi_mom, y = B * 0.95, label = "Observed Efficacy", color = "red", angle = 90, vjust = -0.5)
```

```{r}
# Calculate empirical p-value
set.seed(123)
B <- 100
psi_null = 0.3
n = 170
x = 8
### probability of COVID with vaccine
cases_vaccine = (1-psi_null)/(2-psi_null)
### probability of COVID with no vaccine 
cases_placebo = 1-cases_vaccine

for(i in 1:B) {
  sample_boot = sample(c(1, 0), size = n, replace = TRUE, prob = c(cases_vaccine, cases_placebo)) 
  x = length(which(sample_boot == 1))
  boot_values[i] = (n - 2 * x) / (n - x)
}
empirical_p_value <- mean(boot_values >= psi_mom)
cat("Empirical p-value:", empirical_p_value, "\n")
```


The plot will show the 95% confidence interval for the vaccine efficacy estimate, with the observed MOM estimate indicated by a red dashed line and a blue point. This visualization helps to see the variability and central tendency of the MOM estimates obtained from bootstrapping


# Discussion/Conclusion:


# References:

https://www.cell.com/molecular-therapy-family/molecular-therapy/fulltext/S1525-0016(21)00395-6#secsectitle0025
https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD015477/full
https://www.thelancet.com/journals/ebiom/article/PIIS2666-5247(21)00069-0/fulltext

# Appendix:
